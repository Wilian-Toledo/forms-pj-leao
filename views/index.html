<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha Cadastral - Pessoa Jur√≠dica | Le√£o</title>
  <link rel="stylesheet" href="/public/styles.css" />
</head>
<body>
  <div class="page">
    <header class="hero">
      <img class="hero-logo" src="/public/leao-logo.jpg" alt="Le√£o Alimentos e Bebidas" />
      <h1>Ficha Cadastral - Pessoa Jur√≠dica</h1>
      <p>Preencha todos os campos obrigat√≥rios (*) para completar seu cadastro</p>
    </header>

    <main class="card">

      <form id="form" action="/submit" method="post" enctype="multipart/form-data" novalidate>
        <!-- üë§ Informa√ß√µes do Executivo -->
        <section class="section">
          <h2>üë§ Informa√ß√µes do Executivo</h2>
          <p class="section-sub">Dados do executivo respons√°vel pelo cadastro</p>
          <div class="grid g3">
            <label>Nome do Executivo *<input name="nomeExecutivo" required></label>
            <label>Nome do Coordenador *<input name="nomeCoordenador" required></label>
            <label>Nome do Gerente *<input name="nomeGerente" required></label>
          </div>
        </section>

        <!-- üìã Dados da Empresa -->
        <section class="section">
          <h2>üìã Dados da Empresa</h2>
          <p class="section-sub">Informa√ß√µes b√°sicas da empresa</p>
          <div class="grid g3">
            <label>Raz√£o Social *<input name="razaoSocial" required></label>
            <label>Nome Fantasia *<input name="nomeFantasia" required></label>
            <label>CNPJ *<input id="cnpj" name="cnpj" inputmode="numeric" maxlength="18" placeholder="00.000.000/0000-00" required></label>
            <label>Inscri√ß√£o Estadual *<input name="inscricaoEstadual" placeholder="Digite ISENTO se n√£o possuir" required></label>
            <label>Inscri√ß√£o Municipal *<input name="inscricaoMunicipal" placeholder="Digite ISENTO se n√£o possuir" required></label>
          </div>
        </section>

        <!-- üìû Contatos -->
        <section class="section">
          <h2>üìû Contatos</h2>
          <p class="section-sub">Informa√ß√µes de contato da empresa</p>

          <h3 class="legend">Respons√°vel Principal</h3>
          <div class="grid g3">
            <label>Nome do Respons√°vel Principal *<input name="nomeResponsavel" required></label>
            <label>Telefone Principal *<input id="telPrincipal" name="telefone" placeholder="(11) 99999-9999" maxlength="15" required></label>
            <label>E-mail Principal *<input type="email" name="email" required></label>
          </div>

          <h3 class="legend">Contato Comercial</h3>
          <div class="grid g3">
            <label>Nome do Contato Comercial *<input name="nomeContatoComercial" required></label>
            <label>Telefone do Contato Comercial *<input id="telComercial" name="telefoneContatoComercial" placeholder="(11) 99999-9999" maxlength="15" required></label>
            <label>E-mail do Contato Comercial *<input type="email" name="emailContatoComercial" required></label>
          </div>

          <h3 class="legend">Contato Financeiro</h3>
          <div class="grid g3">
            <label>Nome do Contato Financeiro *<input name="nomeContatoFinanceiro" required></label>
            <label>Telefone do Contato Financeiro *<input id="telFinanceiro" name="telefoneContatoFinanceiro" placeholder="(11) 99999-9999" maxlength="15" required></label>
            <label>E-mail do Contato Financeiro *<input type="email" name="emailContatoFinanceiro" required></label>
          </div>
        </section>

        <!-- üè† Endere√ßo Principal -->
        <section class="section">
          <h2>üè† Endere√ßo Principal</h2>
          <p class="section-sub">Endere√ßo principal da empresa</p>
          <div class="grid g3">
            <label>CEP *<input id="cepPrincipal" name="cepPrincipal" placeholder="00000-000" maxlength="9" inputmode="numeric" required></label>
            <label>N√∫mero *<input name="numeroPrincipal" required></label>
            <div></div>
            <label>Rua *<input id="ruaPrincipal" name="logradouroPrincipal" required></label>
            <label>Bairro *<input id="bairroPrincipal" name="bairroPrincipal" required></label>
            <label>Cidade *<input id="cidadePrincipal" name="cidadePrincipal" required></label>
            <label>Estado (UF) *<input id="ufPrincipal" name="ufPrincipal" maxlength="2" required></label>
          </div>
        </section>

        <!-- ‚ùì Endere√ßos Adicionais -->
        <section class="section">
          <h2>‚ùì Endere√ßos Adicionais</h2>
          <p class="section-sub">Confirme se os endere√ßos de entrega e cobran√ßa s√£o os mesmos do endere√ßo principal.</p>
          <div class="grid g2">
            <label>O endere√ßo principal √© o mesmo do endere√ßo de entrega? *
              <div class="row">
                <label class="radio"><input type="radio" name="entregaIgual" value="sim" checked> Sim</label>
                <label class="radio"><input type="radio" name="entregaIgual" value="nao"> N√£o</label>
              </div>
            </label>
            <label>O endere√ßo principal √© o mesmo do endere√ßo de cobran√ßa? *
              <div class="row">
                <label class="radio"><input type="radio" name="cobrancaIgual" value="sim" checked> Sim</label>
                <label class="radio"><input type="radio" name="cobrancaIgual" value="nao"> N√£o</label>
              </div>
            </label>
          </div>
        </section>

        <!-- Entrega -->
        <section id="secEntrega" class="section hidden">
          <h3>üöö Endere√ßo de Entrega</h3>
          <div class="grid g3">
            <label>CEP *<input id="cepEntrega" name="cepEntrega" placeholder="00000-000" maxlength="9"></label>
            <label>N√∫mero *<input name="numeroEntrega"></label>
            <div></div>
            <label>Rua *<input id="ruaEntrega" name="logradouroEntrega"></label>
            <label>Bairro *<input id="bairroEntrega" name="bairroEntrega"></label>
            <label>Cidade *<input id="cidadeEntrega" name="cidadeEntrega"></label>
            <label>Estado (UF) *<input id="ufEntrega" name="ufEntrega" maxlength="2"></label>
          </div>
        </section>

        <!-- Cobran√ßa -->
        <section id="secCobranca" class="section hidden">
          <h3>üìÑ Endere√ßo de Cobran√ßa</h3>
          <div class="grid g3">
            <label>CEP *<input id="cepCobranca" name="cepCobranca" placeholder="00000-000" maxlength="9"></label>
            <label>N√∫mero *<input name="numeroCobranca"></label>
            <div></div>
            <label>Rua *<input id="ruaCobranca" name="logradouroCobranca"></label>
            <label>Bairro *<input id="bairroCobranca" name="bairroCobranca"></label>
            <label>Cidade *<input id="cidadeCobranca" name="cidadeCobranca"></label>
            <label>Estado (UF) *<input id="ufCobranca" name="ufCobranca" maxlength="2"></label>
          </div>
        </section>

        <!-- üè¶ Dados Banc√°rios -->
        <section class="section">
          <h2>üè¶ Dados Banc√°rios</h2>
          <p class="section-sub">Informa√ß√µes banc√°rias da empresa</p>
          <div class="grid g3">
            <label>Banco * 
              <select id="banco" name="nomeBanco" required>
                <option value="">Carregando...</option>
              </select>
            </label>
            <label>Ag√™ncia *<input name="agencia" required></label>
            <label>Conta *<input name="conta" required></label>
            <label>Tipo de Conta * 
              <select name="tipoConta" required>
                <option value="">Selecione</option>
                <option>Corrente</option>
                <option>Poupan√ßa</option>
                <option>Pagamento</option>
                <option>Outra</option>
              </select>
            </label>
          </div>
        </section>

        <!-- üíº Dados Comerciais -->
        <section class="section">
          <h2>üíº Dados Comerciais</h2>
          <p class="section-sub">Informa√ß√µes comerciais da empresa</p>
          <div class="grid g2">
            <label>Limite de Cr√©dito Solicitado (R$) *<input type="number" name="limiteCredito" placeholder="Ex: 50000" required></label>
            <label>Prazo M√©dio de Pagamento (dias) *<input type="number" name="prazoMedioPagamento" placeholder="Ex: 30" required></label>
            <label>Faturamento Mensal M√©dio (R$) *<input type="number" name="faturamentoMensal" placeholder="Ex: 100000" required></label>
            <label>Tempo de Atua√ß√£o no Mercado (anos) *<input type="number" name="tempoMercado" placeholder="Ex: 5" required></label>
          </div>

          <div id="anexosObrigatorios" class="info hidden">
            <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Para limites de cr√©dito superiores a R$ 20.000,00, anexe:
            <ul>
              <li><strong>Balan√ßo Patrimonial</strong> (√∫ltimo exerc√≠cio)</li>
              <li><strong>Faturamento dos √∫ltimos 12 meses</strong></li>
            </ul>
            <div class="grid g2">
              <label>Balan√ßo Patrimonial *<input type="file" name="doc_balanco" accept=".pdf,.doc,.docx"></label>
              <label>Faturamento 12 meses *<input type="file" name="doc_faturamento" accept=".pdf,.doc,.docx"></label>
            </div>
          </div>
        </section>

        <!-- üéØ Segmento de Vendas -->
        <section class="section">
          <h2>üéØ Segmento de Vendas</h2>
          <p class="section-sub">Selecione os segmentos de vendas que sua empresa atende</p>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="Varejo"> Varejo</label>
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="Distribuidor"> Distribuidor</label>
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="Atacado"> Atacado</label>
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="KACC"> KACC</label>
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="Cash & Care"> Cash & Care</label>
            <label class="chip"><input type="checkbox" name="segmentoVendas" value="Canais Especiais"> Canais Especiais</label>
          </div>
        </section>

        <!-- üè™ Redes -->
        <section class="section">
          <h2>üè™ Redes</h2>
          <p class="section-sub">Selecione o tipo de rede que sua empresa representa</p>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="redes" value="Varejo"> Varejo</label>
            <label class="chip"><input type="checkbox" name="redes" value="Distribuidor"> Distribuidor</label>
          </div>
        </section>

        <!-- üìé Anexos gerais -->
        <section class="section">
          <h2>üìé Anexar Documentos</h2>
          <p class="section-sub">Formatos aceitos: PDF, DOC, DOCX, PNG, JPG. M√°x. 5MB por arquivo.</p>
          <input type="file" name="anexos" multiple accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
        </section>

        <!-- üßæ Dados Fiscais -->
        <section class="section">
          <h2>üßæ Dados Fiscais</h2>
          <div class="grid g2">
            <fieldset class="fieldset">
              <legend>Regime Tribut√°rio *</legend>
              <label class="radio"><input type="radio" name="regimeTributario" value="Lucro Real" required> Lucro Real</label>
              <label class="radio"><input type="radio" name="regimeTributario" value="Lucro Presumido" required> Lucro Presumido</label>
              <label class="radio"><input type="radio" name="regimeTributario" value="SIMPLES" required> SIMPLES</label>
              <label class="radio"><input type="radio" name="regimeTributario" value="N√£o Contribuinte ICMS" required> N√£o Contribuinte ICMS</label>
            </fieldset>
            <fieldset class="fieldset">
              <legend>Cliente possui Regime Especial? *</legend>
              <label class="radio"><input type="radio" name="regimeEspecial" value="Sim" required> Sim</label>
              <label class="radio"><input type="radio" name="regimeEspecial" value="N√£o" required> N√£o</label>
            </fieldset>
          </div>
        </section>

        <div class="actions">
          <button class="btn" type="submit">ENVIAR CADASTRO</button>
          <span id="status" class="muted"></span>
        </div>
      </form>

      <div id="ok" class="hidden ok">
        <h3>‚úÖ Cadastro Enviado com Sucesso!</h3>
        <p>Seus dados foram enviados para an√°lise. Em breve entraremos em contato.</p>
        <p><strong>Protocolo:</strong> <span id="protocolo"></span></p>
        <button class="btn" onclick="window.location.reload()">Realizar Novo Cadastro</button>
      </div>

    </main>
  </div>

  <script>
    // ===== Helpers
    const onlyDigits = s => (s||'').replace(/\D+/g,'');
    const maskCNPJ = v => {
      const d = onlyDigits(v).slice(0,14);
      return d
        .replace(/(\d{2})(\d)/,'$1.$2')
        .replace(/(\d{2})\.(\d{3})(\d)/,'$1.$2.$3')
        .replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/,'$1.$2.$3/$4')
        .replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d{1,2})$/,'$1.$2.$3/$4-$5');
    };
    const maskPhone = v => {
      const d = onlyDigits(v).slice(0,11);
      return d.length <= 10
        ? d.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3')
        : d.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
    };
    const maskCEP = v => onlyDigits(v).slice(0,8).replace(/(\d{5})(\d{0,3})/, '$1-$2');

    const bindMask = (id, fn) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', e => e.target.value = fn(e.target.value));
    };

    // Masks
    bindMask('cnpj', maskCNPJ);
    ['telPrincipal','telComercial','telFinanceiro'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return;
      el.addEventListener('input', e => e.target.value = maskPhone(e.target.value));
    });
    ['cepPrincipal','cepEntrega','cepCobranca'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return;
      el.addEventListener('input', e => e.target.value = maskCEP(e.target.value));
    });

    // CEP -> ViaCEP
    async function viaCEP(cep){
      const c = onlyDigits(cep);
      if (c.length !== 8) return null;
      try{
        const r = await fetch(`https://viacep.com.br/ws/${c}/json/`);
        const j = await r.json();
        if (j.erro) return null;
        return { rua:j.logradouro||'', bairro:j.bairro||'', cidade:j.localidade||'', uf:j.uf||'' };
      }catch{ return null; }
    }
    async function fillByCEP(prefix){
      const cep = document.getElementById(`cep${prefix}`).value;
      const data = await viaCEP(cep);
      if (!data) return;
      document.getElementById(`rua${prefix}`).value = data.rua;
      document.getElementById(`bairro${prefix}`).value = data.bairro;
      document.getElementById(`cidade${prefix}`).value = data.cidade;
      document.getElementById(`uf${prefix}`).value = data.uf;
    }
    ['Principal','Entrega','Cobranca'].forEach(p=>{
      const el = document.getElementById(`cep${p}`);
      if (el) el.addEventListener('blur', ()=> fillByCEP(p));
    });

    // Condicional (entrega/cobran√ßa)
    const secEntrega = document.getElementById('secEntrega');
    const secCobranca = document.getElementById('secCobranca');
    function toggleSection(name, show){
      const node = name==='entrega' ? secEntrega : secCobranca;
      node.classList.toggle('hidden', !show);
      const req = (on, ids)=> ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.required = on; });
      if (name==='entrega') req(show, ['cepEntrega','ruaEntrega','numeroEntrega','bairroEntrega','cidadeEntrega','ufEntrega']);
      else req(show, ['cepCobranca','ruaCobranca','numeroCobranca','bairroCobranca','cidadeCobranca','ufCobranca']);
    }
    document.querySelectorAll('input[name="entregaIgual"]').forEach(r=>r.addEventListener('change', e=>toggleSection('entrega', e.target.value==='nao')));
    document.querySelectorAll('input[name="cobrancaIgual"]').forEach(r=>r.addEventListener('change', e=>toggleSection('cobranca', e.target.value==='nao')));
    toggleSection('entrega', false);
    toggleSection('cobranca', false);

    // Lista de bancos (BrasilAPI + fallback)
    (async function loadBanks(){
      const sel = document.getElementById('banco');
      try{
        const r = await fetch('https://brasilapi.com.br/api/banks/v1');
        const list = (await r.json()).sort((a,b)=>a.fullName.localeCompare(b.fullName));
        sel.innerHTML = '<option value="">Selecione...</option>' + list.map(b=>`<option>${b.code} - ${b.fullName}</option>`).join('');
      }catch{
        const fallback = ['001 - Banco do Brasil','033 - Santander','104 - Caixa Econ√¥mica Federal','237 - Bradesco','341 - Ita√∫','077 - Inter','260 - Nubank','290 - PagBank','336 - C6 Bank','323 - Mercado Pago','212 - Original'];
        sel.innerHTML = '<option value="">Selecione...</option>' + fallback.map(x=>`<option>${x}</option>`).join('');
      }
    })();

    // Anexos obrigat√≥rios > 20k
    const limiteEl = document.querySelector('input[name="limiteCredito"]');
    const anexosBox = document.getElementById('anexosObrigatorios');
    function checkAnexos(){
      const v = Number(limiteEl.value||0);
      anexosBox.classList.toggle('hidden', !(v>20000));
      // marca required quando vis√≠vel
      anexosBox.querySelectorAll('input[type="file"]').forEach(el=> el.required = v>20000);
    }
    limiteEl.addEventListener('input', checkAnexos);

    // Submiss√£o
    const form = document.getElementById('form');
    const statusEl = document.getElementById('status');
    const ok = document.getElementById('ok');
    const protocoloEl = document.getElementById('protocolo');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent = 'Enviando...';
      const fd = new FormData(form);
      try{
        const resp = await fetch('/submit', { method:'POST', body: fd });
        const json = await resp.json();
        if (!json.ok) throw new Error();
        form.classList.add('hidden');
        ok.classList.remove('hidden');
        protocoloEl.textContent = json.protocol || '‚Äî';
        statusEl.textContent = '';
      }catch{
        statusEl.textContent = 'Falha ao enviar. Tente novamente.';
      }
    });
  </script>
</body>
</html>
